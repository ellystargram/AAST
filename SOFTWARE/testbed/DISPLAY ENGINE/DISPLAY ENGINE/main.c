//AAST TOP SECRET
#define F_CPU 16000000

#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>

//CODE DEFAULT
#define TRUE 1
#define FALSE 0

//MAX7219 PIN
#define CS PB0
#define CLK PB1
#define DIN PB2

//MAX7219 CONTROL
#define MAX7219_NOP     0x00
#define MAX7219_DIGIT0  0x01
#define MAX7219_DIGIT1  0x02
#define MAX7219_DIGIT2  0x03
#define MAX7219_DIGIT3  0x04
#define MAX7219_DIGIT4  0x05
#define MAX7219_DIGIT5  0x06
#define MAX7219_DIGIT6  0x07
#define MAX7219_DIGIT7  0x08
#define MAX7219_DECODE  0x09
#define MAX7219_INTEN   0x0A
#define MAX7219_SCANLIM 0x0B
#define MAX7219_SHUTDOWN 0x0C
#define MAX7219_TEST    0x0F

void setup_(void);
void update_(void);
void cwrotate__(unsigned char* __origin);
void spisetup_(void);
void spitrans_(unsigned char _data);
void max7219_setup_(void);
void printmax7219_(unsigned char _adress, unsigned char _data);
void printcharviamax7219_(unsigned char _char);
void portbcontroler_(unsigned char _bit, unsigned char _logical_value);
unsigned char getbitofbyte_(unsigned char _byte, unsigned char _bit);


unsigned char _alphabet[52][8]={
	{0x00, 0xfc, 0x22, 0x21, 0x21, 0x22, 0xfc, 0x00},//A
	{0x00, 0xff, 0x89, 0x89, 0x89, 0x89, 0x76, 0x00},//B
	{0x00, 0x3c, 0x42, 0x81, 0x81, 0x42, 0x24, 0x00},//C
	{0x00, 0xff, 0x81, 0x81, 0x81, 0x42, 0x3c, 0x00},//D
	{0x00, 0xff, 0x89, 0x89, 0x89, 0x89, 0x89, 0x00},//E
	{0x00, 0xff, 0x09, 0x09, 0x09, 0x09, 0x09, 0x00},//F
	{0x00, 0x3c, 0x42, 0x81, 0x91, 0x52, 0x34, 0x00},//G
	{0x00, 0xff, 0x08, 0x08, 0x08, 0x08, 0xff, 0x00},//H
	{0x00, 0x81, 0x81, 0xff, 0x81, 0x81, 0x00, 0x00},//I
	{0x00, 0x41, 0x81, 0x81, 0x7f, 0x01, 0x01, 0x00},//J
	{0x00, 0xff, 0x18, 0x24, 0x42, 0x81, 0x00, 0x00},//K
	{0x00, 0xff, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00},//L
	{0x00, 0xff, 0x02, 0x04, 0x04, 0x02, 0xff, 0x00},//M
	{0x00, 0xff, 0x03, 0x0c, 0x30, 0xc0, 0xff, 0x00},//N
	{0x00, 0x3c, 0x42, 0x81, 0x81, 0x42, 0x3c, 0x00},//O
	{0x00, 0xff, 0x09, 0x09, 0x09, 0x09, 0x06, 0x00},//P
	{0x00, 0x3c, 0x42, 0x81, 0x81, 0x62, 0x7c, 0x80},//Q
	{0x00, 0xff, 0x09, 0x19, 0x29, 0x49, 0x86, 0x00},//R
	{0x00, 0x06, 0x89, 0x89, 0x89, 0x89, 0x70, 0x00},//S
	{0x00, 0x01, 0x01, 0xff, 0x01, 0x01, 0x00, 0x00},//T
	{0x00, 0x7f, 0x80, 0x80, 0x80, 0x80, 0x7f, 0x00},//U
	{0x00, 0x0f, 0x70, 0x80, 0x70, 0x0f, 0x00, 0x00},//V
	{0x00, 0xff, 0x60, 0x18, 0x18, 0x60, 0xff, 0x00},//W
	{0x00, 0xc3, 0x24, 0x18, 0x18, 0x24, 0xc3, 0x00},//X
	{0x00, 0x02, 0x04, 0xf8, 0x04, 0x02, 0x00, 0x00},//Y
	{0x00, 0xc1, 0xa1, 0x91, 0x89, 0x85, 0x83, 0x00},//Z
	{0x00, 0x00, 0x48, 0xa4, 0xa4, 0xa4, 0xf8, 0x00},//a
	{0x00, 0x00, 0xfc, 0xa0, 0xa0, 0x40, 0x00, 0x00},//b
	{0x00, 0x00, 0x60, 0x90, 0x90, 0x00, 0x00, 0x00},//c
	{0x00, 0x00, 0x40, 0xa0, 0xa0, 0xfe, 0x00, 0x00},//d
	{0x00, 0x00, 0x70, 0xa8, 0xa8, 0x90, 0x00, 0x00},//e
	{0x00, 0x10, 0x90, 0xfc, 0x14, 0x10, 0x00, 0x00},//f
	{0x00, 0x00, 0x48, 0x94, 0x94, 0x6e, 0x00, 0x00},//g
	{0x00, 0x00, 0xfc, 0x20, 0x20, 0xc0, 0x00, 0x00},//h
	{0x00, 0x00, 0x00, 0xe8, 0x00, 0x00, 0x00, 0x00},//i
	{0x00, 0x00, 0x40, 0x90, 0x74, 0x00, 0x00, 0x00},//j
	{0x00, 0x00, 0xf8, 0x20, 0x50, 0x88, 0x00, 0x00},//k
	{0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00},//l
	{0x00, 0x10, 0xf0, 0x20, 0xc0, 0x20, 0xc0, 0x00},//m
	{0x00, 0x00, 0xe0, 0x10, 0x10, 0xe0, 0x00, 0x00},//n
	{0x00, 0x00, 0x60, 0x90, 0x90, 0x60, 0x00, 0x00},//o
	{0x00, 0x00, 0xfc, 0x14, 0x14, 0x08, 0x00, 0x00},//p
	{0x00, 0x00, 0x08, 0x14, 0x14, 0xfc, 0x00, 0x00},//q
	{0x00, 0x00, 0xf0, 0x20, 0x10, 0x10, 0x00, 0x00},//r
	{0x00, 0x00, 0x10, 0xa8, 0xa8, 0x40, 0x00, 0x00},//s
	{0x00, 0x00, 0x10, 0xf8, 0x90, 0x00, 0x00, 0x00},//t
	{0x00, 0x00, 0x70, 0x80, 0x80, 0x70, 0x00, 0x00},//u
	{0x00, 0x00, 0x70, 0x80, 0x70, 0x00, 0x00, 0x00},//v
	{0x00, 0x60, 0x80, 0x60, 0x80, 0x60, 0x00, 0x00},//w
	{0x00, 0x88, 0x50, 0x20, 0x50, 0x88, 0x00, 0x00},//x
	{0x00, 0x00, 0xb8, 0xa0, 0xa0, 0xf8, 0x00, 0x00},//y
	{0x00, 0x00, 0x90, 0xd0, 0xb0, 0x90, 0x00, 0x00},//z
};

int main(void){
	setup_();
	while(TRUE){
		update_();
		
	}
}

void setup_(void){
	for(unsigned char _rotate=0;_rotate<52;_rotate++){
		cwrotate__(_alphabet[_rotate]);
	}
	DDRB=(1<<CS)|(1<<DIN)|(1<<CLK);
	spisetup_();
	max7219_setup_();
	TCCR0=1;
	TIMSK=(1<<TOIE0);
	sei();
}
void update_(void){
	/*
	for(unsigned char _char=0;_char<52;_char++){
		printmax7219_(MAX7219_DIGIT0,)
		printcharviamax7219_(_char);
		_delay_ms(1000);
	}
	*/
	for(unsigned char _xstart=0;_xstart<48;_xstart++){
		for(unsigned char _y=0;_y<8;_y++){
			portbcontroler_(CS,FALSE);
			for(unsigned char _x=_xstart;_x<_xstart+4;_x++){
				printmax7219_(_y+1,_alphabet[_x][_y]);
			}
			portbcontroler_(CS,TRUE);
		}
		_delay_ms(1000);
	}
	
}
void cwrotate__(unsigned char* __origin){
	unsigned char _drawboard[8]={0,};
	for(unsigned char _y=0;_y<8;_y++){
		for(unsigned char _x=0;_x<8;_x++){
			_drawboard[_y]=_drawboard[_y]|(getbitofbyte_(__origin[_x],(7-_y))<<_x);
		}
	}
	for(unsigned char _duplicate=0;_duplicate<8;_duplicate++){
		__origin[_duplicate]=_drawboard[_duplicate];
	}
}
void spisetup_(void){
	SPCR=(1<<SPE)|(1<<SPR0)|(1<<MSTR);
}
void spitrans_(unsigned char _data){
	SPDR=_data;
	_delay_ms(1);
	while(!(SPSR&(1<<SPIF)));
}
void max7219_setup_(void) {
	portbcontroler_(CS,FALSE);
	for(unsigned char _repeat=0;_repeat<4;_repeat++){
		printmax7219_(MAX7219_TEST, 0x00);     // 테스트 모드 비활성화
	}
	portbcontroler_(CS,TRUE);
	
	portbcontroler_(CS,FALSE);
	for(unsigned char _repeat=0;_repeat<4;_repeat++){
		printmax7219_(MAX7219_SCANLIM, 0x07);   // 모든 자리 활성화 (0 ~ 7)
	}
	portbcontroler_(CS,TRUE);
	
	portbcontroler_(CS,FALSE);
	for(unsigned char _repeat=0;_repeat<4;_repeat++){
		printmax7219_(MAX7219_DECODE, 0x00);   // 디코더 모드 비활성화
	}
	portbcontroler_(CS,TRUE);
	
	portbcontroler_(CS,FALSE);
	for(unsigned char _repeat=0;_repeat<4;_repeat++){
		printmax7219_(MAX7219_INTEN, 0x00);    // 중단 모드 비활성화
	}
	portbcontroler_(CS,TRUE);
	
	portbcontroler_(CS,FALSE);
	for(unsigned char _repeat=0;_repeat<4;_repeat++){
		printmax7219_(MAX7219_SHUTDOWN, 0x01); // 셧다운 모드 해제
	}
	portbcontroler_(CS,TRUE);
	
	
	
	portbcontroler_(CS,TRUE);
}
void printmax7219_(unsigned char _adress, unsigned char _data){
	//portbcontroler_(CS,FALSE);
	spitrans_(_adress);
	spitrans_(_data);
	//portbcontroler_(CS,TRUE);
}
void printcharviamax7219_(unsigned char _char){
	for(unsigned char _digit=0;_digit<8;_digit++){
		printmax7219_(_digit+1,_alphabet[_char][_digit]);
	}
}
void portbcontroler_(unsigned char _bit, unsigned char _logical_value){
	unsigned char _newportb=0;
	for(unsigned char _digit=0;_digit<8;_digit++){
		if(_digit==_bit){
			_newportb=_newportb|(_logical_value<<_bit);
		}
		else{
			_newportb=_newportb|(PORTB&(1<<_digit));
		}
	}
	PORTB=_newportb;
}
unsigned char getbitofbyte_(unsigned char _byte, unsigned char _bit){
	return (_byte>>_bit)&0x01;
}

ISR(TIMER0_OVF_vect){
	
}